<div class="space-y-6">
  @if (entryToChallenge(); as entry) {
    <h1 class="text-3xl font-extrabold text-blue-800 mb-2">گام ۵: چالش و جایگزینی افکار</h1>
    <p class="text-lg text-gray-600 mb-6">در ادامه، اولین یادداشت تکمیل‌نشده‌ی شما نمایش داده شده است. افکار منفی آن را به چالش بکشید.</p>
    
    <div class="bg-white p-6 rounded-xl shadow-md border">
      <p class="text-sm font-semibold text-gray-500">۱. موقعیت</p>
      <p class="mt-1 text-gray-800 break-words">{{ entry.situation }}</p> 
      <hr class="my-4">
      <p class="text-sm font-semibold text-gray-500">۲. احساسات</p>
      <p class="mt-1 text-gray-800">{{ formatFeelings(entry.feelings) }}</p>
    </div>
    
    <form [formGroup]="challengeForm" (ngSubmit)="saveChallenge()">
      <div formArrayName="thoughts" class="space-y-6">
        @for(thoughtGroup of thoughtsArray.controls; track $index) {
          <div [formGroupName]="$index" class="bg-white p-6 rounded-xl shadow-md border space-y-6">
            <div>
              <p class="text-sm font-semibold text-gray-500">۳. فکر منفی خودکار (امتیاز: {{ getThoughtScore(thoughtGroup.value.id) }}/10)</p>
              <p class="p-3 bg-red-50 border-r-4 border-red-400 rounded-md mt-1 text-gray-800 break-words">{{ getThoughtDescription(thoughtGroup.value.id) }}</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
              <h3 class="font-bold text-lg text-gray-700 mb-4">بررسی شواهد (کمک به یافتن فکر جایگزین)</h3>
              <div class="space-y-4 text-sm">
                <div class="space-y-1">
                  <label [for]="'challenge-distortion-' + $index" class="font-semibold text-gray-600">آیا این فکر یک خطای شناختی است یا یک واقعیت؟</label>
                  <textarea [id]="'challenge-distortion-' + $index" formControlName="challenge_distortion" rows="2" class="w-full p-2 border rounded-lg mt-1"></textarea>
                </div>
                <div class="space-y-1">
                  <label [for]="'challenge-experience-' + $index" class="font-semibold text-gray-600">آیا قبلا در این موقعیت بوده‌ام؟ چگونه آن را مدیریت کردم؟</label>
                  <textarea [id]="'challenge-experience-' + $index" formControlName="challenge_experience" rows="2" class="w-full p-2 border rounded-lg mt-1"></textarea>
                </div>
                <div class="space-y-1">
                  <label [for]="'challenge-others-' + $index" class="font-semibold text-gray-600">دیگران در این موقعیت چه کار خواهند کرد؟</label>
                  <textarea [id]="'challenge-others-' + $index" formControlName="challenge_others" rows="2" class="w-full p-2 border rounded-lg mt-1"></textarea>
                </div>
                <div class="space-y-1">
                  <label [for]="'challenge-another-way-' + $index" class="font-semibold text-gray-600">چه شکل دیگری می‌توان به این موقعیت فکر کرد؟</label>
                  <textarea [id]="'challenge-another-way-' + $index" formControlName="challenge_anotherWay" rows="2" class="w-full p-2 border rounded-lg mt-1"></textarea>
                </div>
              </div>
            </div>

            <div class="mb-4 space-y-2">
              <label [for]="'alternative-thought-' + $index" class="block font-bold text-lg text-gray-700">۴. افکار جایگزین</label>
              <textarea [id]="'alternative-thought-' + $index" formControlName="alternativeThought" rows="3" class="w-full p-2 border-2 border-green-200 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
            </div>
            <div class="space-y-2">
              <label [for]="'conclusion-' + $index" class="block font-bold text-lg text-gray-700">۵. نتیجه گیری</label>
              <textarea [id]="'conclusion-' + $index" formControlName="conclusion" rows="3" class="w-full p-2 border-2 border-blue-200 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
          </div>
        }
      </div>
      
      <div class="flex items-center justify-center gap-x-4 pt-8 border-t mt-8">
        <button type="button" (click)="goToPreviousStep()" class="px-8 py-3 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 transition-all w-full md:w-auto">بازگشت به گام ۳</button>
        <button type="submit" [disabled]="challengeForm.invalid" class="px-8 py-3 rounded-lg font-semibold bg-green-500 text-white shadow-md hover:bg-green-600 transition-all w-full md:w-auto disabled:opacity-50">ذخیره و ادامه</button>
      </div>
    </form>
    
  } @else {
    <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
      <h1 class="text-3xl font-extrabold text-green-600 mb-6">تبریک!</h1>
      <p class="text-lg text-gray-700 mb-8">
        شما تمام یادداشت‌های ثبت شده‌ی خود را با موفقیت به چالش کشیده‌اید.
      </p>
      <p class="text-gray-600">
        برای ادامه، می‌توانید به گام ۳ برگردید و یادداشت جدیدی ثبت کنید.
      </p>
      <div class="mt-8 pt-6 border-t">
        <button (click)="goToPreviousStep()" class="px-8 py-3 rounded-lg font-semibold bg-blue-600 text-white shadow-md hover:bg-blue-700 transition-all w-full md:w-auto">
          بازگشت به گام ۳: ثبت افکار
        </button>
      </div>
    </div>
  }
</div>