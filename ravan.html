<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù„ØªÙØ±Ù… Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to Vazirmatn font -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Vazirmatn', 'sans-serif'],
            },
            transitionProperty: {
              'width': 'width',
              'transform': 'transform',
            }
          },
        },
      };
    </script>
    <style>
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-right 0.3s ease-in-out; }
        
        /* Watermark */
        body::after {
            content: "Adel Is Testing";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: clamp(3rem, 8vw, 10rem);
            font-weight: 800;
            color: rgba(0, 0, 0, 0.04);
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
            user-select: none;
        }
        
        /* Fix for number input spin buttons in Firefox */
        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* --- NEW UI/UX STYLES --- */

        /* Sidebar Item States */
        .sidebar-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem; /* 12px 16px */
            border-radius: 0.5rem; /* 8px */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            text-align: right;
        }
        .sidebar-item .sidebar-icon {
            margin-left: 0.75rem; /* 12px */
            flex-shrink: 0;
        }

        /* State: Active (Current Step) */
        .sidebar-item[data-state="active"] {
            background-color: #DBEAFE; /* bg-blue-100 */
            color: #1D4ED8; /* text-blue-700 */
        }

        /* State: Completed (Visited) */
        .sidebar-item[data-state="completed"] {
            color: #374151; /* text-gray-700 */
        }
        .sidebar-item[data-state="completed"]:hover {
            background-color: #F3F4F6; /* bg-gray-100 */
            color: #000;
        }

        /* State: Locked (Not Unlocked) */
        .sidebar-item[data-state="locked"] {
            color: #9CA3AF; /* text-gray-400 */
            opacity: 0.7;
            pointer-events: none;
        }

        /* Kebab Menu (for Edit/Delete) */
        .kebab-dropdown {
            position: absolute;
            left: 0; /* Positioned to the left in RTL */
            top: 100%; /* Below the toggle button */
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #E5E7EB;
            z-index: 10;
            width: 140px;
            padding: 0.5rem;
        }
        .kebab-dropdown button {
            display: block;
            width: 100%;
            text-align: right;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .kebab-dropdown button:hover {
            background-color: #F3F4F6;
        }

    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col min-h-screen">

    <!-- 1. APP SHELL -->
    <div id="app-container" class="w-full flex-grow"></div>
    
    <!-- Pop-up & Modal Containers -->
    <div id="message-box" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 py-3 px-6 rounded-full shadow-lg transition-opacity duration-500 opacity-0 hidden text-white font-bold text-center z-50"></div>
    <div id="edit-modal" class="fixed inset-0 w-full h-full z-40 hidden"></div>

    <!-- 2. JAVASCRIPT LOGIC -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SECTION 0: STATE DECLARATION (Initial Values) ---
            // Declared within DOMContentLoaded for safety against global scope issues
            let currentUser = null;
            let screeningAnswers = [];
            let thoughtLog = [];
            let screeningResults = null;
            let isLoginMode = true;
            let currentStepId = 'screening'; 
            let currentEntryId = null; 
            let isSidebarOpen = false;
            let unlockedSteps = ['screening'];
            
            // --- SECTION 1: GLOBAL STATE & UI SVGs ---
            
            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const messageBox = document.getElementById('message-box');
            const editModalContainer = document.getElementById('edit-modal');

            // --- UI SVGs ---
            const icons = {
                screening: `<svg class="w-6 h-6 sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`,
                intro: `<svg class="w-6 h-6 sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>`,
                log: `<svg class="w-6 h-6 sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>`,
                identify: `<svg class="w-6 h-6 sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>`,
                challenge: `<svg class="w-6 h-6 sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`,
                completed: `<svg class="w-6 h-6 sidebar-icon text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                locked: `<svg class="w-6 h-6 sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>`,
                kebab: `<svg class="w-5 h-5 text-gray-500 hover:text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01"></path></svg>`
            };
            
            // --- App State ---
            const questions = [
                "1. Ø§Ø­Ø³Ø§Ø³ ØºÙ… ÛŒØ§ Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ", "2. Ø¨ÛŒâ€ŒØ¹Ù„Ø§Ù‚Ú¯ÛŒ ÛŒØ§ Ù„Ø°Øªâ€ŒÙ†Ø¨Ø±Ø¯Ù† Ø§Ø² ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§", "3. ØªØºÛŒÛŒØ± Ø¯Ø± Ø§Ø´ØªÙ‡Ø§ ÛŒØ§ ÙˆØ²Ù†", "4. Ù…Ø´Ú©Ù„Ø§Øª Ø®ÙˆØ§Ø¨", "5. Ø§Ø­Ø³Ø§Ø³ Ø®Ø³ØªÚ¯ÛŒ Ù…ÙØ±Ø·", "6. Ø§Ø­Ø³Ø§Ø³ Ø¨ÛŒâ€ŒØ§Ø±Ø²Ø´ÛŒ ÛŒØ§ Ú¯Ù†Ø§Ù‡", "7. Ù…Ø´Ú©Ù„ Ø¯Ø± ØªÙ…Ø±Ú©Ø²", "8. Ú©Ù†Ø¯ÛŒ ÛŒØ§ Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø±ÛŒ Ø±ÙˆØ§Ù†ÛŒ-Ø­Ø±Ú©ØªÛŒ", "9. Ø§ÙÚ©Ø§Ø± Ù…Ø±Ú¯ ÛŒØ§ Ø®ÙˆØ¯Ú©Ø´ÛŒ", "10. Ø§Ø­Ø³Ø§Ø³ Ù¾ÙˆÚ†ÛŒ", "11. Ú©Ø§Ù‡Ø´ Ø§Ù†Ú¯ÛŒØ²Ù‡", "12. Ø§Ù†Ø²ÙˆØ§ Ø§Ø² Ø¯ÛŒÚ¯Ø±Ø§Ù†", "13. Ù†Ú¯Ø±Ø§Ù†ÛŒ Ù…Ø²Ù…Ù† Ùˆ Ø¨ÛŒâ€ŒØ¯Ù„ÛŒÙ„", "14. ØªÙ†Ø´ Ø¹Ø¶Ù„Ø§Ù†ÛŒ ÛŒØ§ Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø±ÛŒ", "15. ØªÙ¾Ø´ Ù‚Ù„Ø¨ Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ", "16. ØªØ¹Ø±ÛŒÙ‚ Ø²ÛŒØ§Ø¯", "17. Ù„Ø±Ø²Ø´ ÛŒØ§ Ø§Ø­Ø³Ø§Ø³ Ù„Ø±Ø²Ø´", "18. Ø§Ø­Ø³Ø§Ø³ Ø®ÙÚ¯ÛŒ ÛŒØ§ ØªÙ†Ú¯ÛŒ Ù†ÙØ³", "19. Ø¯Ø±Ø¯ ÛŒØ§ Ù†Ø§Ø±Ø§Ø­ØªÛŒ Ø¯Ø± Ù‚ÙØ³Ù‡ Ø³ÛŒÙ†Ù‡", "20. Ø³Ø±Ú¯ÛŒØ¬Ù‡ ÛŒØ§ Ø³Ø¨Ú©ÛŒ Ø³Ø±", "21. ØªØ±Ø³ Ø§Ø² Ù…Ø±Ø¯Ù†", "22. ØªØ±Ø³ Ø§Ø² Ø¯ÛŒÙˆØ§Ù†Ù‡ Ø´Ø¯Ù†", "23. Ø¬Ø¯Ø§ Ø´Ø¯Ù† Ø§Ø² ÙˆØ§Ù‚Ø¹ÛŒØª", "24. Ø§Ø² Ø¯Ø³Øª Ø¯Ø§Ø¯Ù† Ú©Ù†ØªØ±Ù„", "25. Ø§Ù†Ø±Ú˜ÛŒ Ø²ÛŒØ§Ø¯ ÛŒØ§ ØºÛŒØ±Ø¹Ø§Ø¯ÛŒ", "26. Ù†ÛŒØ§Ø² Ú©Ù… Ø¨Ù‡ Ø®ÙˆØ§Ø¨", "27. Ù¾Ø±Ø­Ø±ÙÛŒ", "28. Ø§ÙØ²Ø§ÛŒØ´ Ø¹Ø²Øª Ù†ÙØ³ ÛŒØ§ Ø¨Ø²Ø±Ú¯â€ŒØ¨ÛŒÙ†ÛŒ", "29. Ø§ÙÚ©Ø§Ø± Ø³Ø±ÛŒØ¹", "30. Ø­ÙˆØ§Ø³â€ŒÙ¾Ø±ØªÛŒ", "31. Ø§ÙØ²Ø§ÛŒØ´ ÙØ¹Ø§Ù„ÛŒØª Ù‡Ø¯Ùâ€ŒØ¯Ø§Ø±", "32. Ø±ÙØªØ§Ø±Ù‡Ø§ÛŒ Ù¾Ø±Ø®Ø·Ø±", "33. ØªØ­Ø±ÛŒÚ©â€ŒÙ¾Ø°ÛŒØ±ÛŒ Ø´Ø¯ÛŒØ¯", "34. ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§ÛŒ ØºÛŒØ±Ù…Ù†Ø·Ù‚ÛŒ", "35. ÙˆÙ„Ø®Ø±Ø¬ÛŒ ÛŒØ§ Ø¨ÛŒâ€ŒÙ…Ù„Ø§Ø­Ø¸Ú¯ÛŒ", "36. Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯ ÛŒØ§ Ø§Ù„Ú©Ù„", "37. ØªØºÛŒÛŒØ±Ø§Øª Ø®Ù„Ù‚â€ŒÙˆØ®ÙˆÛŒ Ø´Ø¯ÛŒØ¯", "38. ÙØ¹Ø§Ù„ÛŒØª Ø¬Ù†Ø³ÛŒ Ø¨ÛŒØ´â€ŒØ§Ø²Ø­Ø¯", "39. ØªØ±Ø³ Ø§Ø² ÙØ¶Ø§Ù‡Ø§ÛŒ Ø¨Ø§Ø²", "40. ØªØ±Ø³ Ø§Ø² ØªÙ†Ù‡Ø§ Ù…Ø§Ù†Ø¯Ù†", "41. ØªØ±Ø³ Ø§Ø² Ø­Ø¶ÙˆØ± Ø¯Ø± Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø´Ù„ÙˆØº", "42. Ø§Ø¬ØªÙ†Ø§Ø¨ Ø§Ø² Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ", "43. Ø§ÙÚ©Ø§Ø± Ù…Ø²Ø§Ø­Ù… Ùˆ Ù†Ø§Ø®ÙˆØ§Ø³ØªÙ‡", "44. Ø´Ú© Ù…Ø¯Ø§ÙˆÙ… Ùˆ ÙˆØ³ÙˆØ§Ø³ ÙÚ©Ø±ÛŒ", "45. Ø±ÙØªØ§Ø±Ù‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù…Ø«Ù„ Ø´Ø³ØªÙ† ÛŒØ§ Ú†Ú©â€ŒÚ©Ø±Ø¯Ù†", "46. ØªØ±Ø³ Ø§Ø² Ù‚Ø¶Ø§ÙˆØª Ø¯ÛŒÚ¯Ø±Ø§Ù†", "47. Ø§Ø¬ØªÙ†Ø§Ø¨ Ø§Ø² ØµØ­Ø¨Øª Ø¯Ø± Ø¬Ù…Ø¹", "48. Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", "49. Ø³Ø±Ø® Ø´Ø¯Ù† ÛŒØ§ Ù„Ø±Ø²Ø´ Ø¯Ø± Ø¬Ù…Ø¹"
            ];
            
            // --- Utility Functions ---
            
            const enforceNumberLimit = (e) => {
                if (e.target.type === 'number' && e.target.classList.contains('number-input')) {
                    let value = e.target.value.replace(/[^0-9]/g, '');
                    if (value === '') { e.target.value = ''; return; }
                    let num = parseInt(value, 10);
                    if (isNaN(num)) { e.target.value = ''; }
                    else if (num < 0) { e.target.value = 0; }
                    else if (num > 10) { e.target.value = 10; }
                    else { e.target.value = num; }
                }
            };
            document.addEventListener('input', enforceNumberLimit);

            const showMessage = (text, isError = false) => {
                messageBox.textContent = text;
                messageBox.classList.remove('hidden', 'opacity-0', 'bg-blue-500', 'bg-red-500');
                messageBox.classList.add('opacity-100', isError ? 'bg-red-500' : 'bg-blue-500');
                setTimeout(() => {
                    messageBox.classList.remove('opacity-100');
                    setTimeout(() => messageBox.classList.add('hidden'), 500);
                }, 3000);
            };

            const saveUserData = () => {
                if (!currentUser) return;
                let users = JSON.parse(localStorage.getItem('users')) || {};
                if (users[currentUser.email]) {
                    users[currentUser.email].answers = screeningAnswers;
                    users[currentUser.email].thoughtLog = thoughtLog;
                    users[currentUser.email].unlockedSteps = unlockedSteps;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                localStorage.setItem('currentStepId', currentStepId); 
            };

            const loadUserData = () => {
                // Read/Refresh global currentUser
                currentUser = JSON.parse(localStorage.getItem('currentUser')); 
                
                if (!currentUser) {
                    // Set safe initial defaults if logged out
                    screeningAnswers = new Array(questions.length).fill(false);
                    thoughtLog = [];
                    unlockedSteps = ['screening'];
                    currentStepId = 'screening';
                    return; 
                }

                let users = JSON.parse(localStorage.getItem('users')) || {};
                const userData = users[currentUser.email];
                
                if (userData) {
                    screeningAnswers = userData.answers || new Array(questions.length).fill(false);
                    thoughtLog = userData.thoughtLog || [];
                    unlockedSteps = userData.unlockedSteps || ['screening']; 
                } else {
                    // Safety initialization for new/corrupt users
                    screeningAnswers = new Array(questions.length).fill(false);
                    thoughtLog = [];
                    unlockedSteps = ['screening'];
                }
                
                currentStepId = localStorage.getItem('currentStepId') || 'screening';
            };

            // NEW: Helper to unlock steps and re-render sidebar
            const unlockStep = (stepId) => {
                if (!unlockedSteps.includes(stepId)) {
                    unlockedSteps.push(stepId);
                    saveUserData();
                    renderSidebarNav(); 
                }
            };


            // --- SECTION 2: MODULE: CORE APP LAYOUT (Sidebar & Shell) ---
            
            const htmlTemplates_AppLayout = `
                <div class="flex w-full h-full">
                    <!-- Sidebar (Right) -->
                    <aside id="sidebar" class="w-64 bg-white shadow-lg p-6 flex flex-col flex-shrink-0
                                                fixed md:relative h-full
                                                transform md:translate-x-0 translate-x-full
                                                sidebar z-30
                                                right-0 top-0">
                        <div class="flex items-center justify-between mb-10">
                            <h2 class="text-2xl font-extrabold text-blue-800 text-center">
                                Ù¾Ù„ØªÙØ±Ù… Ø³Ù„Ø§Ù…Øª
                            </h2>
                            <button id="close-sidebar-btn" class="md:hidden p-1 text-gray-600 hover:text-black">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                        
                        <!-- NEW: Storytelling Nav Container -->
                        <nav id="sidebar-nav-container" class="flex flex-col gap-y-2"></nav>

                        <div class="mt-auto pt-6 border-t border-gray-200">
                            <p id="user-email-display" class="text-sm text-gray-500 mb-3 text-center truncate"></p>
                            <button id="logout-button" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg shadow-sm hover:bg-red-600 text-sm font-semibold transition-all">
                                Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content (Left) -->
                    <main class="flex-1 w-full main-content md:mr-64 overflow-y-auto">
                        <div class="bg-white shadow-md p-4 flex items-center justify-between md:hidden sticky top-0 z-10">
                            <button id="open-sidebar-btn" class="p-2 text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            </button>
                            <h3 class="font-bold text-lg text-blue-800" id="mobile-page-title"></h3>
                        </div>
                        <div id="page-content-container" class="p-4 md:p-8 max-w-7xl mx-auto"></div>
                    </main>
                    
                    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden"></div>
                </div>
            `;

            const openSidebar = () => {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (sidebar) sidebar.classList.remove('translate-x-full');
                if (overlay) overlay.classList.remove('hidden');
                isSidebarOpen = true;
            };
            
            const closeSidebar = () => {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                if (sidebar) sidebar.classList.add('translate-x-full');
                if (overlay) overlay.classList.add('hidden');
                isSidebarOpen = false;
            };
            
            // NEW: Rewritten to render the 5-step journey
            const renderSidebarNav = () => {
                const navContainer = document.getElementById('sidebar-nav-container');
                const userEmailDisplay = document.getElementById('user-email-display');
                
                if (!navContainer || !userEmailDisplay) return; 

                userEmailDisplay.textContent = currentUser.email;
                
                // Add listeners that only need to be set once
                if (!document.getElementById('logout-button')._listenerAttached) {
                    document.getElementById('logout-button').addEventListener('click', handleLogout);
                    document.getElementById('logout-button')._listenerAttached = true;
                }
                if (!document.getElementById('open-sidebar-btn')._listenerAttached) {
                    document.getElementById('open-sidebar-btn').addEventListener('click', openSidebar);
                    document.getElementById('open-sidebar-btn')._listenerAttached = true;
                }
                if (!document.getElementById('close-sidebar-btn')._listenerAttached) {
                    document.getElementById('close-sidebar-btn').addEventListener('click', closeSidebar);
                    document.getElementById('close-sidebar-btn')._listenerAttached = true;
                }
                if (!document.getElementById('sidebar-overlay')._listenerAttached) {
                    document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);
                    document.getElementById('sidebar-overlay')._listenerAttached = true;
                }


                navContainer.innerHTML = ''; 
                let activeModuleTitle = '';
                
                journeySteps.forEach(step => {
                    const isUnlocked = unlockedSteps.includes(step.id);
                    const isActive = step.id === currentStepId;
                    const isCompleted = isUnlocked && !isActive && unlockedSteps.indexOf(step.id) < unlockedSteps.indexOf(currentStepId);

                    let state = 'locked';
                    let icon = icons.locked;

                    if (isActive) {
                        state = 'active';
                        icon = step.icon; // Use the step's own icon
                        activeModuleTitle = step.title;
                    } else if (isCompleted) {
                        state = 'completed';
                        icon = icons.completed; // Use the green check icon
                    } else if (isUnlocked) {
                        // Unlocked but not active and not completed (e.g., user clicked back)
                        state = 'completed'; // Treat as 'completed' for navigation
                        icon = step.icon;
                    }
                    
                    const button = document.createElement('button');
                    button.id = `nav-${step.id}`;
                    button.className = 'sidebar-item';
                    button.dataset.state = state;
                    button.innerHTML = `${icon} <span class="flex-1">${step.title}</span>`;
                    
                    if (isUnlocked) {
                        button.addEventListener('click', () => {
                            currentStepId = step.id;
                            saveUserData(); // Save the new step
                            mainRouter();
                            if (isSidebarOpen) closeSidebar(); 
                        });
                    }
                    navContainer.appendChild(button);
                });
                
                document.getElementById('mobile-page-title').textContent = activeModuleTitle;
            };

            const renderAppLayout = () => {
                appContainer.innerHTML = htmlTemplates_AppLayout;
                // Note: renderSidebarNav() is now called *after* this in mainRouter()
            };
            
            // --- SECTION 3: MODULE: AUTHENTICATION ---
            
            const htmlTemplates_Auth = `
                <div class="flex items-center justify-center min-h-[80vh]">
                    <div class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-md mx-4">
                        <h2 id="auth-title" class="text-3xl font-extrabold text-center text-gray-800 mb-8"></h2>
                        <div class="flex flex-col space-y-4">
                            <input id="email" type="email" placeholder="Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all"/>
                            <input id="password" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all"/>
                            <button id="auth-button" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-all"></button>
                            <button id="toggle-mode-button" class="text-sm text-blue-500 hover:text-blue-700 mt-2"></button>
                        </div>
                        <div class="mt-8 pt-4 border-t">
                            <button id="clear-all-data-button" class="text-xs text-gray-500 hover:text-red-600 w-full">ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÛŒØ§ Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
                        </div>
                    </div>
                </div>
            `;

            const renderAuthForm = () => {
                appContainer.innerHTML = htmlTemplates_Auth; 
                
                document.getElementById('auth-title').textContent = isLoginMode ? 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ' : 'Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ';
                document.getElementById('auth-button').textContent = isLoginMode ? 'ÙˆØ±ÙˆØ¯' : 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…';
                document.getElementById('toggle-mode-button').textContent = isLoginMode ? 'Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯.' : 'Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.';
                document.getElementById('auth-button').addEventListener('click', handleAuth);
                document.getElementById('toggle-mode-button').addEventListener('click', () => {
                    isLoginMode = !isLoginMode;
                    renderAuthForm();
                });
                document.getElementById('clear-all-data-button').addEventListener('click', handleClearAllData);
            };
            
            const handleAuth = () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                let users = JSON.parse(localStorage.getItem('users')) || {};
                
                if (!email || !password) {
                    showMessage("Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯.", true);
                    return;
                }

                if (isLoginMode) {
                    if (users[email] && users[email].password === password) {
                        localStorage.setItem('currentUser', JSON.stringify({ email: email }));
                        showMessage("Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯.");
                        mainRouter();
                    } else {
                        showMessage("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.", true);
                    }
                } else { // Signup
                    if (users[email]) {
                        showMessage("Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.", true);
                    } else {
                        users[email] = { 
                            password: password, 
                            answers: new Array(questions.length).fill(false), 
                            thoughtLog: [],
                            unlockedSteps: ['screening'] // NEW: Set default journey
                        };
                        localStorage.setItem('users', JSON.stringify(users));
                        localStorage.setItem('currentUser', JSON.stringify({ email: email }));
                        showMessage("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
                        mainRouter();
                    }
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentStepId');
                
                showMessage("Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.");
                mainRouter();
            };

            const handleClearAllData = () => {
                if (window.confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ (Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§) Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.")) {
                    localStorage.removeItem('users');
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('currentStepId');
                    
                    isLoginMode = true;
                    showMessage("ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.");
                    // After clearing, re-run router to initialize fresh state
                    mainRouter();
                }
            };

            // --- SECTION 4: MODULE: SCREENING (Step 1) ---
            
            const htmlTemplates_Screening = `
                <div class="bg-white p-8 rounded-2xl shadow-xl">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 mb-6">Ú¯Ø§Ù… Û±: ØªØ³Øª ØºØ±Ø¨Ø§Ù„Ú¯Ø±ÛŒ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø®ØªÛŒ</h1>
                    <p class="text-lg text-gray-700 mb-8">Ù…ÙˆØ§Ø±Ø¯ÛŒ Ø±Ø§ Ú©Ù‡ Ø¯Ø± Ø®ÙˆØ¯ ØªØ¬Ø±Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŒ Ø¹Ù„Ø§Ù…Øª Ø¨Ø²Ù†ÛŒØ¯:</p>
                    <div id="questions-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
                    <div class="flex flex-wrap justify-center gap-4 mb-8">
                        <button id="submit-button" class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-all w-full md:w-auto">ØªØ­Ù„ÛŒÙ„ Ù†ØªØ§ÛŒØ¬</button>
                        <button id="clear-button" class="px-8 py-3 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition-all w-full md:w-auto">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
                    </div>
                    <div id="results-container"></div>
                </div>
            `;
            
            const renderScreeningPage = () => {
                const pageContainer = document.getElementById('page-content-container');
                if (!pageContainer) return; 
                pageContainer.innerHTML = htmlTemplates_Screening;

                let questionsHtml = questions.map((q, index) => `
                    <label class="flex items-center p-4 rounded-xl cursor-pointer transition-colors border-2 ${screeningAnswers[index] ? 'bg-blue-100 border-blue-500' : 'bg-white border-gray-300 hover:bg-gray-50'}">
                        <input type="checkbox" data-index="${index}" class="form-checkbox h-6 w-6 text-blue-600 rounded-md" ${screeningAnswers[index] ? 'checked' : ''}>
                        <span class="mr-4 text-sm font-medium text-gray-800">${q}</span>
                    </label>`).join('');

                let resultsHtml = '';
                if (screeningResults) {
                     const listItems = screeningResults.length > 0
                         ? screeningResults.map(r => `<li class="text-lg font-medium py-1">ğŸ”¹ ${r}</li>`).join('')
                         : `<p class="font-bold text-lg">Ù‡ÛŒÚ† Ø§Ù„Ú¯ÙˆÛŒ Ù…Ø´Ø®ØµÛŒ Ø§Ø² Ø§Ø®ØªÙ„Ø§Ù„Ø§Øª Ø±Ø§ÛŒØ¬ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†Ø´Ø¯.</p>`;
                    resultsHtml = `
                        <div class="mt-10 p-6 rounded-2xl bg-gray-50 border-2">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Ù†ØªÛŒØ¬Ù‡ ØºØ±Ø¨Ø§Ù„Ú¯Ø±ÛŒ</h2>
                            <div class="p-4 ${screeningResults.length > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'} rounded-xl">
                                ${screeningResults.length > 0 ? '<p class="font-bold text-lg mb-2">â—ï¸Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø´Ù…Ø§ Ù†Ø´Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯:</p>' : ''}
                                <ul class="list-none pr-2">${listItems}</ul>
                            </div>
                            <div class="text-center mt-8 pt-6 border-t">
                                <button id="go-to-intro-btn" class="px-8 py-3 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition-all w-full md:w-auto">
                                    Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ù‡ Ú¯Ø§Ù… Û²: Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡
                                </button>
                            </div>
                        </div>`;
                }
                
                document.getElementById('questions-container').innerHTML = questionsHtml;
                document.getElementById('results-container').innerHTML = resultsHtml;
                
                document.getElementById('submit-button').addEventListener('click', analyzeScreeningResults);
                document.getElementById('clear-button').addEventListener('click', handleClearScreening);
                
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        screeningAnswers[e.target.dataset.index] = e.target.checked;
                        e.target.closest('label').classList.toggle('bg-blue-100', e.target.checked);
                        e.target.closest('label').classList.toggle('border-blue-500', e.target.checked);
                        saveUserData(); 
                    });
                });

                if (screeningResults) {
                    document.getElementById('go-to-intro-btn').addEventListener('click', () => {
                        // NEW: Unlock and navigate
                        unlockStep('pathIntro');
                        currentStepId = 'pathIntro';
                        mainRouter();
                    });
                }
            };
            
            const analyzeScreeningResults = () => {
                const results = [];
                const d = screeningAnswers;
                if ((d[0] || d[1]) && d.slice(2, 12).filter(a => a).length >= 4) { results.push("Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ"); } 
                else if ((d[0] && d[1]) && d.slice(2, 12).filter(a => a).length >= 3) { if (!results.includes("Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ")) { results.push("Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ"); } }
                if (d[12] && d[13]) { results.push("Ø§Ø¶Ø·Ø±Ø§Ø¨ ÙØ±Ø§Ú¯ÛŒØ±"); }
                if (d.slice(14, 20).filter(a => a).length >= 2 && d.slice(20, 24).filter(a => a).length >= 1) { results.push("Ø­Ù…Ù„Ù‡ Ù¾Ø§Ù†ÛŒÚ©"); }
                if (d.slice(24, 38).filter(a => a).length >= 4 && results.includes("Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ")) { results.push("Ø§Ø®ØªÙ„Ø§Ù„ Ø¯ÙˆÙ‚Ø·Ø¨ÛŒ"); }
                if (d.slice(38, 42).some(a => a)) { results.push("Ù‡Ø±Ø§Ø³ Ø§Ø² Ù…Ú©Ø§Ù† (Ø¢Ú¯ÙˆØ±Ø§ÙÙˆØ¨ÛŒØ§)"); }
                if (d.slice(42, 44).some(a => a)) { results.push("ÙˆØ³ÙˆØ§Ø³ ÙÚ©Ø±ÛŒ"); }
                if (d[44]) { results.push("ÙˆØ³ÙˆØ§Ø³ Ø¹Ù…Ù„ÛŒ"); }
                if (results.includes("ÙˆØ³ÙˆØ§Ø³ ÙÚ©Ø±ÛŒ") && results.includes("ÙˆØ³ÙˆØ§Ø³ Ø¹Ù…Ù„ÛŒ")) { results.push("ÙˆØ³ÙˆØ§Ø³ ÙÚ©Ø±ÛŒ-Ø¹Ù…Ù„ÛŒ"); }
                if (d.slice(45, 49).some(a => a)) { results.push("Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ"); }
                
                screeningResults = results;
                saveUserData();
                showMessage("Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
                renderScreeningPage();
            };
            
            const handleClearScreening = () => {
                screeningAnswers.fill(false);
                screeningResults = null;
                saveUserData();
                renderScreeningPage();
                showMessage("ÙØ±Ù… Ù¾Ø§Ú© Ø´Ø¯.");
            };
            
            // --- SECTION 5: MODULE: PATH INTRO (Step 2) ---

            const htmlTemplates_PathIntro = `
                <div class="bg-white p-8 md:p-10 rounded-2xl shadow-xl">
                    <div class="border-b border-gray-200 pb-6 mb-8">
                        <h1 class="text-3xl font-extrabold text-blue-800 mb-4">
                            Ú¯Ø§Ù… Û²: Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø§ÙÚ©Ø§Ø± Ùˆ Ø§Ø­Ø³Ø§Ø³Ø§Øª)
                        </h1>
                        <p class="text-lg text-gray-700 leading-relaxed">
                            Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ± Ùˆ Ø¯Ø±Ú© Ø¹Ù…ÛŒÙ‚â€ŒØªØ± Ù…ÙØ§Ù‡ÛŒÙ… Ø§Ø±Ø§Ø¦Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± Ù…Ù†Ø§Ø¨Ø¹ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§ÛŒÙ† Ù…ÙØ§Ù‡ÛŒÙ… Ø´Ø§Ù…Ù„ Ø§Ø±ØªØ¨Ø§Ø· Ø¨ÛŒÙ† Ø§ÙÚ©Ø§Ø± Ùˆ Ø§Ø­Ø³Ø§Ø³Ø§ØªØŒ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§ÙÚ©Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ù†ÙÛŒ Ùˆ ÙÙ‡Ø±Ø³ØªÛŒ Ø¬Ø§Ù…Ø¹ Ø§Ø² Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒ Ø§Ø³Øª.
                        </p>
                    </div>
                    
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Ø¢Ø²Ù…ÙˆÙ† (Ø³ÙˆØ§Ù„Ø§Øª Ú©ÙˆØªØ§Ù‡ Ù¾Ø§Ø³Ø®)</h2>
                        <p class="text-gray-600 mb-6">Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ÙˆØ§Ù„ØŒ Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø± Ø­Ø¯ÙˆØ¯ Û² ØªØ§ Û³ Ø¬Ù…Ù„Ù‡ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.</p>
                        <ol class="list-decimal list-inside space-y-5 text-gray-800 text-lg">
                            <li>Ù‡Ø¯Ù Ø§ØµÙ„ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†ÛŒ Ú©Ù‡ Ø¯Ø± Ù…Ù†Ø§Ø¨Ø¹ Ù…Ø¹Ø±ÙÛŒ Ø´Ø¯Ù‡ Ú†ÛŒØ³ØªØŸ</li>
                            <li>Ø±Ø§Ø¨Ø·Ù‡ Ø¨ÛŒÙ† Ø§ÙÚ©Ø§Ø±ØŒ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ùˆ Ø±ÙØªØ§Ø±Ù‡Ø§ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø·Ø§Ù„Ø¨ ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯.</li>
                            <li>Ø§ÛŒÙ† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø± ØªØ¹Ø¯ÛŒÙ„ Ú©Ø¯Ø§Ù… Ø³Ù‡ Ø§Ø­Ø³Ø§Ø³ Ù…Ù†ÙÛŒ ØªÙ…Ø±Ú©Ø² Ø¯Ø§Ø±Ø¯ØŸ</li>
                            <li>"Ø¬Ø¯ÙˆÙ„ Ø³Ù‡ Ø³ØªÙˆÙ†ÛŒ" Ú†ÛŒØ³Øª Ùˆ Ù‡Ø± ÛŒÚ© Ø§Ø² Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¢Ù† Ú†Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø±Ø§ Ø¯Ø± Ø¨Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ØŸ</li>
                            <li>Ø®Ø·Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒ "Ø°Ù‡Ù†â€ŒØ®ÙˆØ§Ù†ÛŒ" Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ú©Ø±Ø¯Ù‡ Ùˆ ÛŒÚ© Ù…Ø«Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¢Ù† Ø¨ÛŒØ§ÙˆØ±ÛŒØ¯.</li>
                        </ol>
                    </div>

                    <hr class="my-10 border-gray-200">

                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Ú©Ù„ÛŒØ¯ Ù¾Ø§Ø³Ø®Ù†Ø§Ù…Ù‡</h2>
                        <ol class="list-decimal list-inside space-y-6 text-gray-700 leading-relaxed">
                            <li><p>Ù‡Ø¯Ù Ø§ØµÙ„ÛŒ Ø§ÛŒÙ† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ú©Ù…Ú© Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø´ØªÙ† Ø­Ø³ Ùˆ Ø­Ø§Ù„ Ø¨Ù‡ØªØ± Ø§Ø³Øª...</p></li>
                            <li><p>Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø·Ø§Ù„Ø¨ØŒ Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø¨ØªØ¯Ø§ Ø§ÙÚ©Ø§Ø± Ø¨Ù‡ Ø³Ø±Ø§Øº Ù…Ø§ Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯ Ùˆ Ø§ÛŒÙ† Ø§ÙÚ©Ø§Ø±ØŒ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ù…Ø§ Ø±Ø§ Ø´Ú©Ù„ Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯...</p></li>
                            <li><p>Ø§ÛŒÙ† Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¨Ø± ØªØ¹Ø¯ÛŒÙ„ Ú©Ø¯Ø§Ù… Ø³Ù‡ Ø§Ø­Ø³Ø§Ø³ Ù…Ù†ÙÛŒ ØªÙ…Ø±Ú©Ø² Ø¯Ø§Ø±Ø¯: ØºÙ…ØŒ Ø®Ø´Ù… Ùˆ Ø§Ø¶Ø·Ø±Ø§Ø¨...</p></li>
                            <li><p>"Ø¬Ø¯ÙˆÙ„ Ø³Ù‡ Ø³ØªÙˆÙ†ÛŒ" Ø§Ø¨Ø²Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§ÙÚ©Ø§Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ù…Ù†ÙÛŒ Ø§Ø³Øª...</p></li>
                            <li><p>"Ø°Ù‡Ù†â€ŒØ®ÙˆØ§Ù†ÛŒ" Ø®Ø·Ø§ÛŒÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ø¢Ù† ÙØ±Ø¯ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù…ÛŒâ€ŒØ¯Ø§Ù†Ø¯ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ú†Ù‡ ÙÚ©Ø±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯...</p></li>
                        </ol>
                    </div>

                    <!-- Other content omitted for brevity, but would be here -->

                    <hr class="my-10 border-gray-200">

                    <div class="text-center mt-8 pt-6 border-t">
                        <button id="start-treatment-btn" class="px-10 py-4 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-all w-full md:w-auto">
                            Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ù‡ Ú¯Ø§Ù… Û³: Ø«Ø¨Øª Ø§ÙÚ©Ø§Ø±
                        </button>
                    </div>
                    
                </div>
            `;
            
            const renderPathIntroPage = () => {
                const pageContainer = document.getElementById('page-content-container');
                if (!pageContainer) return;
                pageContainer.innerHTML = htmlTemplates_PathIntro;
                
                document.getElementById('start-treatment-btn').addEventListener('click', () => {
                    // NEW: Unlock and navigate
                    unlockStep('thoughtLog');
                    currentStepId = 'thoughtLog'; 
                    mainRouter();
                });
            };

            // --- SECTION 6: MODULE: THOUGHT LOG (Step 3) ---
            
            const htmlTemplates_ThoughtLog = `
                <div class="space-y-8">
                    <div class="bg-white p-8 rounded-2xl shadow-xl border">
                        <h1 class="text-3xl font-extrabold text-blue-800 mb-6">Ú¯Ø§Ù… Û³: Ø«Ø¨Øª Ø§ÙÚ©Ø§Ø± (Ø¬Ø¯ÙˆÙ„ Û³ Ø³ØªÙˆÙ†ÛŒ)</h1>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div class="flex flex-col space-y-2"><label for="thought-situation" class="font-semibold">Û±. Ù…ÙˆÙ‚Ø¹ÛŒØª</label><textarea id="thought-situation" rows="4" class="w-full p-3 border rounded-xl"></textarea></div>
                            <div class="flex flex-col space-y-2"><label class="font-semibold">Û². Ø§Ø­Ø³Ø§Ø³Ø§Øª (Û°-Û±Û°)</label><div class="space-y-3 pt-2">
                                <div class="flex items-center justify-between"><label>ØºÙ…</label><input type="number" id="feeling-sad" min="0" max="10" class="w-20 p-2 border rounded-lg text-center number-input"></div>
                                <div class="flex items-center justify-between"><label>Ø®Ø´Ù…</label><input type="number" id="feeling-happy" min="0" max="10" class="w-20 p-2 border rounded-lg text-center number-input"></div>
                                <div class="flex items-center justify-between"><label>Ø§Ø¶Ø·Ø±Ø§Ø¨</label><input type="number" id="feeling-anxious" min="0" max="10" class="w-20 p-2 border rounded-lg text-center number-input"></div>
                            </div></div>
                            <div class="flex flex-col space-y-2"><label class="font-semibold">Û³. Ø§ÙÚ©Ø§Ø± Ù…Ù†ÙÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</label>
                                <div id="new-thoughts-container" class="space-y-4">
                                    <div class="new-thought-group space-y-2">
                                        <textarea rows="3" class="w-full p-2 border rounded-xl" placeholder="ÙÚ©Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                                        <input type="number" min="0" max="10" class="w-full p-2 border text-center rounded-lg number-input" placeholder="Ø´Ø¯Øª ÙÚ©Ø± (Û°-Û±Û°)">
                                    </div>
                                </div>
                                <button id="add-thought-button" class="mt-4 text-sm text-blue-600 font-semibold self-start hover:text-blue-800">+ Ø§ÙØ²ÙˆØ¯Ù† ÙÚ©Ø± Ø¯ÛŒÚ¯Ø±</button>
                            </div>
                        </div>
                        <div class="text-center mt-8 pt-6 border-t">
                            <button id="save-thought-button" class="px-10 py-4 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-all w-full md:w-auto">
                                Ø«Ø¨Øª ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-100 p-4 md:p-8 rounded-2xl shadow-inner">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</h2>
                        <div id="log-entries-container" class="space-y-4"></div>
                        
                        <!-- NEW: Removed the confusing "Next Step" button from here. Navigation is via sidebar. -->
                    </div>
                </div>
            `;
            
            const renderThoughtLogPage = () => {
                const pageContainer = document.getElementById('page-content-container');
                if (!pageContainer) return;
                pageContainer.innerHTML = htmlTemplates_ThoughtLog;
                
                const logEntriesHtml = thoughtLog.map(entry => {
                    const isPhase3Complete = entry.negativeThoughts.every(t => t.alternativeThought && t.conclusion);
                    
                    const statusBadge = isPhase3Complete 
                        ? `<span class="inline-flex items-center gap-x-1.5 rounded-md bg-green-100 px-2 py-1 text-xs font-medium text-green-700">âœ“ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</span>`
                        : `<span class="inline-flex items-center gap-x-1.5 rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-500">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>`;

                    // NEW: Kebab Menu Structure
                    return `
                    <div class="bg-white p-5 rounded-xl shadow-md border grid grid-cols-1 md:grid-cols-3 gap-6 relative">
                        <div class="space-y-2"><h4 class="font-bold text-gray-600 border-b pb-1">Ù…ÙˆÙ‚Ø¹ÛŒØª</h4><p class="text-gray-800 break-words">${entry.situation}</p></div>
                        <div class="space-y-2"><h4 class="font-bold text-gray-600 border-b pb-1">Ø§Ø­Ø³Ø§Ø³ / Ø§Ù…ØªÛŒØ§Ø²</h4>${entry.feelings.map(f => `<span>${f.name}: <span class="font-bold text-blue-600">${f.score}/10</span></span>`).join('<br>')}</div>
                        <div class="space-y-2"><h4 class="font-bold text-gray-600 border-b pb-1">Ø§ÙÚ©Ø§Ø± Ù…Ù†ÙÛŒ / Ø§Ù…ØªÛŒØ§Ø²</h4>
                            <ul class="list-disc pr-5 space-y-2 text-gray-800">${entry.negativeThoughts.map(t => `<li class="break-words">${t.description} <span class="font-semibold text-red-600">(${t.score}/10)</span></li>`).join('')}</ul>
                        </div>
                        
                        <!-- NEW: Kebab Menu -->
                        <div class="absolute top-3 left-3">
                            <div class="relative kebab-menu">
                                <button data-id="${entry.id}" class="kebab-toggle p-2 rounded-full hover:bg-gray-100">
                                    ${icons.kebab}
                                </button>
                                <div data-id="dropdown-${entry.id}" class="kebab-dropdown hidden">
                                    <button data-id="${entry.id}" class="edit-thought-btn text-blue-600">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                                    <button data-id="${entry.id}" class="delete-thought-btn text-red-500">Ø­Ø°Ù</button>
                                </div>
                            </div>
                        </div>

                        <div class="absolute bottom-3 left-3">${statusBadge}</div> 
                    </div>`;
                }).join('') || `<p class="text-center text-gray-500 col-span-full">Ù‡Ù†ÙˆØ² ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;

                document.getElementById('log-entries-container').innerHTML = logEntriesHtml;
                
                attachThoughtLogListeners(); 
            };
            
            const handleSaveThought = () => {
                const situation = document.getElementById('thought-situation').value;
                const thoughtNodes = document.querySelectorAll('.new-thought-group');
                const negativeThoughts = [];
                
                thoughtNodes.forEach(node => {
                    const description = node.querySelector('textarea').value;
                    const score = node.querySelector('input[type="number"]').value;
                    if (description && score) {
                        negativeThoughts.push({ 
                            id: Date.now() + Math.random(), description, score: parseInt(score),
                            challenge_distortion: '', challenge_experience: '', challenge_others: '', challenge_anotherWay: '',
                            alternativeThought: '', conclusion: ''
                        });
                    }
                });

                if (!situation || negativeThoughts.length === 0) {
                    showMessage("Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙÚ©Ø± Ù…Ù†ÙÛŒ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.", true);
                    return;
                }
                
                const newThought = {
                    id: Date.now(), situation, negativeThoughts,
                    feelings: [
                        { name: 'ØºÙ…', score: parseInt(document.getElementById('feeling-sad').value) || 0 },
                        { name: 'Ø®Ø´Ù…', score: parseInt(document.getElementById('feeling-happy').value) || 0 },
                        { name: 'Ø§Ø¶Ø·Ø±Ø§Ø¨', score: parseInt(document.getElementById('feeling-anxious').value) || 0 }
                    ]
                };
                thoughtLog.unshift(newThought);
                
                // NEW: Unlock next step on first save
                unlockStep('identifyThoughts');
                
                saveUserData();
                renderThoughtLogPage();
                showMessage("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯.");
            };
            
            const handleDeleteThought = (id) => {
                if (window.confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) {
                    thoughtLog = thoughtLog.filter(thought => thought.id !== id);
                    saveUserData();
                    renderThoughtLogPage();
                    showMessage("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø­Ø°Ù Ø´Ø¯.");
                }
            };

            // NEW: Listener for Kebab Menus
            const attachKebabListeners = () => {
                // Close all dropdowns when clicking anywhere
                document.body.addEventListener('click', (e) => {
                    document.querySelectorAll('.kebab-dropdown').forEach(dropdown => {
                        if (!dropdown.parentElement.contains(e.target)) {
                            dropdown.classList.add('hidden');
                        }
                    });
                }, true); // Use capture phase

                document.querySelectorAll('.kebab-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation(); // Stop click from bubbling to body
                        const id = e.currentTarget.dataset.id;
                        const dropdown = document.querySelector(`div[data-id="dropdown-${id}"]`);
                        
                        // Close all *other* dropdowns
                        document.querySelectorAll('.kebab-dropdown').forEach(d => {
                            if (d !== dropdown) d.classList.add('hidden');
                        });
                        
                        dropdown.classList.toggle('hidden');
                    });
                });

                document.querySelectorAll('.edit-thought-btn').forEach(btn => {
                    // FIX: Close dropdown immediately when action is clicked
                    btn.addEventListener('click', (e) => {
                         e.currentTarget.closest('.kebab-dropdown').classList.add('hidden');
                         openEditModal(parseInt(e.currentTarget.dataset.id));
                    });
                });
                document.querySelectorAll('.delete-thought-btn').forEach(btn => {
                    // FIX: Close dropdown immediately when action is clicked
                    btn.addEventListener('click', (e) => {
                         e.currentTarget.closest('.kebab-dropdown').classList.add('hidden');
                         handleDeleteThought(parseInt(e.currentTarget.dataset.id));
                    });
                });
            };
            
            const attachThoughtLogListeners = () => {
                document.getElementById('save-thought-button').addEventListener('click', handleSaveThought);
                document.getElementById('add-thought-button').addEventListener('click', () => {
                    const container = document.getElementById('new-thoughts-container');
                    const newThoughtGroup = document.createElement('div');
                    newThoughtGroup.className = 'new-thought-group space-y-2 border-t pt-4 mt-4 relative';
                    newThoughtGroup.innerHTML = `
                        <textarea rows="3" class="w-full p-2 border rounded-xl" placeholder="ÙÚ©Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                        <input type="number" min="0" max="10" class="w-full p-2 border text-center rounded-lg number-input" placeholder="Ø´Ø¯Øª ÙÚ©Ø± (Û°-Û±Û°)">
                        <button class="remove-thought-btn absolute -top-2 right-0 text-red-500 hover:text-red-700 w-8 h-8 flex items-center justify-center text-2xl font-bold">&times;</button>
                    `;
                    container.appendChild(newThoughtGroup);
                    newThoughtGroup.querySelector('.remove-thought-btn').addEventListener('click', () => newThoughtGroup.remove());
                });
                
                // NEW: Kebab listeners
                attachKebabListeners();
            };

            // --- SECTION 7: MODULE: IDENTIFY NEGATIVE THOUGHTS (Step 4) ---
            
            const htmlTemplates_IdentifyThoughts = `
                 <div class="container mx-auto max-w-6xl">
                    <div class="bg-white p-8 md:p-10 rounded-2xl shadow-xl">
                        <header class="text-center mb-10 border-b pb-8">
                            <h1 class="text-4xl md:text-5xl font-bold mb-4" style="color: #2e294e;">Ú¯Ø§Ù… Û´: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒ Ú†ÛŒØ³ØªØŸ</h1>
                        </header>

                        <section class="bg-gray-50 rounded-lg p-6 mb-12 flex flex-col md:flex-row items-center justify-between">
                            <div class="md:w-2/3 mb-6 md:mb-0 md:mr-8">
                                <p class="text-lg mb-4">
                                    Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒØŒ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ ÙÚ©Ø±ÛŒ Ù‡Ø³ØªÙ†Ø¯ Ú©Ù‡ Ù¾Ø´ØªÙˆØ§Ù†Ù‡Ù” Ù…Ù†Ø·Ù‚ÛŒ Ùˆ Ø´ÙˆØ§Ù‡Ø¯ Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±Ù†Ø¯. Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø¯Ù„ÛŒÙ„ Ø¨Ù‡ Ø¢Ù†â€ŒÙ‡Ø§ Â«Ø®Ø·Ø§ÛŒ ÙÚ©Ø±ÛŒÂ» Ú¯ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                                </p>
                                <p class="text-gray-600">
                                    Ù‡Ù…Ù‡Ù” Ø§Ù†Ø³Ø§Ù†â€ŒÙ‡Ø§ Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ø±Ø§ ØªØ¬Ø±Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø± Ø§ÙØ±Ø§Ø¯ÛŒ Ø¨Ø§ Ø¹Ø²Øªâ€ŒÙ†ÙØ³ Ù¾Ø§ÛŒÛŒÙ†ØŒ Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ ÛŒØ§ Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø´Ø§ÛŒØ¹â€ŒØªØ± Ù‡Ø³ØªÙ†Ø¯. Ø´Ù†Ø§Ø®Øª Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ø§ÙˆÙ„ÛŒÙ† Ù‚Ø¯Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ù†â€ŒÙ‡Ø§Ø³Øª.
                                </p>
                            </div>
                            <div class="flex flex-col items-center text-center">
                                <span class="text-8xl md:text-9xl font-bold" style="color: #d7263d;">Û±Û·</span>
                                <span class="text-xl font-semibold text-gray-700 mt-2">Ø®Ø·Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒ Ø±Ø§ÛŒØ¬</span>
                            </div>
                        </section>

                        <!-- Content omitted for brevity... -->
                        <section class="mb-12">
                            <h2 class="text-2xl font-bold mb-4 mt-8 flex items-center" style="color: #d7263d;">
                                <span class="text-3xl mr-3">ğŸ”</span>
                                Ú¯Ø±ÙˆÙ‡ Û±: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¯Ø±Ø§Ú©ÛŒ (ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù†)
                            </h2>
                            <p class="mb-6 text-gray-600">Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ù†Ø­ÙˆÙ‡ Ø¯Ø±Ú© Ù…Ø§ Ø§Ø² ÙˆØ§Ù‚Ø¹ÛŒØª Ø±Ø§ Ø¨Ø§ ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø«Ø¨Øª ÛŒØ§ ØªÙ…Ø±Ú©Ø² Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¨Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù†ÙÛŒ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯.</p>
                        </section>

                        <section class="mb-12">
                            <h2 class="text-3xl font-bold text-center mb-4" style="color: #2e294e;">Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒ</h2>
                            <p class="text-center text-gray-600 max-w-3xl mx-auto mb-8">
                                Û±Û· Ø®Ø·Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø§Ø±Ú©Ø±Ø¯ Ù…Ø´ØªØ±Ú© Ø¢Ù†â€ŒÙ‡Ø§ Ø¯Ø± Û¶ Ú¯Ø±ÙˆÙ‡ Ø§ØµÙ„ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯. Ù„ÛŒØ³Øª Ø²ÛŒØ±ØŒ ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·Ø§Ù‡Ø§ Ø¯Ø± Ù‡Ø± Ú¯Ø±ÙˆÙ‡ Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯:
                            </p>
                            <div class="bg-white rounded-lg shadow-xl p-6 max-w-xl mx-auto border-4" style="border-color: #2e294e;">
                                <ul class="space-y-4 text-lg">
                                    <li class="flex justify-between items-center pb-3 border-b border-gray-200">
                                        <span class="font-semibold" style="color: #f46036;">Ú¯Ø±ÙˆÙ‡ Û²: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù‚Ø¶Ø§ÙˆØª (Ù¾Ø±Ø´ Ø¨Ù‡ Ù†ØªÛŒØ¬Ù‡)</span>
                                        <span class="font-bold text-2xl" style="color: #d7263d;">Û´ Ø®Ø·Ø§</span>
                                    </li>
                                    <li class="flex justify-between items-center pb-3 border-b border-gray-200">
                                        <span class="font-semibold" style="color: #d7263d;">Ú¯Ø±ÙˆÙ‡ Û±: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¯Ø±Ø§Ú©ÛŒ (ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù†)</span>
                                        <span class="font-bold text-2xl" style="color: #f46036;">Û³ Ø®Ø·Ø§</span>
                                    </li>
                                    <li class="flex justify-between items-center pb-3 border-b border-gray-200">
                                        <span class="font-semibold" style="color: #2e294e;">Ú¯Ø±ÙˆÙ‡ Û³: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ÛŒ (Ø§ØºØ±Ø§Ù‚)</span>
                                        <span class="font-bold text-2xl" style="color: #f46036;">Û³ Ø®Ø·Ø§</span>
                                    </li>
                                    <li class="flex justify-between items-center pb-3 border-b border-gray-200">
                                        <span class="font-semibold" style="color: #c5d86d;">Ú¯Ø±ÙˆÙ‡ Ûµ: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²Ù…Ø§Ù† Ùˆ Ø­Ø³Ø±Øª</span>
                                        <span class="font-bold text-2xl" style="color: #f46036;">Û³ Ø®Ø·Ø§</span>
                                    </li>
                                    <li class="flex justify-between items-center pb-3 border-b border-gray-200">
                                        <span class="font-semibold" style="color: #1b998b;">Ú¯Ø±ÙˆÙ‡ Û´: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª (Ø³Ø±Ø²Ù†Ø´)</span>
                                        <span class="font-bold text-2xl" style="color: #f46036;">Û² Ø®Ø·Ø§</span>
                                    </li>
                                    <li class="flex justify-between items-center">
                                        <span class="font-semibold" style="color: #618dbe;">Ú¯Ø±ÙˆÙ‡ Û¶: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡</span>
                                        <span class="font-bold text-2xl" style="color: #f46036;">Û² Ø®Ø·Ø§</span>
                                    </li>
                                </ul>
                            </div>
                        </section>

                        <section class="mb-12">
                            <!-- FIX: Changed from ml-3 to mr-3 for RTL -->
                            <h2 class="text-2xl font-bold mb-4 mt-8 flex items-center" style="color: #d7263d;">
                                <span class="text-3xl mr-3">ğŸ”</span>
                                Ú¯Ø±ÙˆÙ‡ Û±: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø§Ø¯Ø±Ø§Ú©ÛŒ (ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù†)
                            </h2>
                            <p class="mb-6 text-gray-600">Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ù†Ø­ÙˆÙ‡ Ø¯Ø±Ú© Ù…Ø§ Ø§Ø² ÙˆØ§Ù‚Ø¹ÛŒØª Ø±Ø§ Ø¨Ø§ ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø«Ø¨Øª ÛŒØ§ ØªÙ…Ø±Ú©Ø² Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¨Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù†ÙÛŒ ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Ûµ. Ù†Ø§Ø¯ÛŒØ¯Ù‡â€ŒÚ¯Ø±ÙØªÙ† Ø¬Ù†Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø«Ø¨Øª</h3>
                                    <p>Ú©ÙˆÚ†Ú© Ø´Ù…Ø±Ø¯Ù† ØªÙˆØ§Ù†Ø§ÛŒÛŒâ€ŒÙ‡Ø§ØŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒÙ‡Ø§ ÛŒØ§ Ø®ÙˆØ¨ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯.</p>
                                </div>
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û¶. ÙÛŒÙ„ØªØ± Ù…Ù†ÙÛŒ</h3>
                                    <p>Ø¯ÛŒØ¯Ù† ÙÙ‚Ø· Ù†ÛŒÙ…Ù‡Ù” Ø®Ø§Ù„ÛŒ Ù„ÛŒÙˆØ§Ù† Ùˆ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ù†Ú©Ø§Øª Ù…Ø«Ø¨Øª.</p>
                                </div>

                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û¸. ØªÙÚ©Ø± Ø¯Ùˆ Ù‚Ø·Ø¨ÛŒ</h3>
                                    <p>Ø¯ÛŒØ¯Ù† Ø¯Ù†ÛŒØ§ Ø¨Ù‡ ØµÙˆØ±Øª ØµÙØ± Ùˆ ØµØ¯ØŒ Ø³ÛŒØ§Ù‡ ÛŒØ§ Ø³ÙÛŒØ¯.</p>
                                </div>
                            </div>
                        </section>

                        <section class="mb-12">
                            <!-- FIX: Changed from ml-3 to mr-3 for RTL -->
                            <h2 class="text-2xl font-bold mb-4 mt-8 flex items-center" style="color: #d7263d;">
                                <span class="text-3xl mr-3">âš–ï¸</span>
                                Ú¯Ø±ÙˆÙ‡ Û²: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù‚Ø¶Ø§ÙˆØª (Ù¾Ø±Ø´ Ø¨Ù‡ Ù†ØªÛŒØ¬Ù‡)
                            </h2>
                            <p class="mb-6 text-gray-600">Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ø²Ù…Ø§Ù†ÛŒ Ø±Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯ Ú©Ù‡ Ù…Ø§ Ø¨Ø¯ÙˆÙ† Ø´ÙˆØ§Ù‡Ø¯ Ú©Ø§ÙÛŒØŒ Ø¨Ù‡ Ù†ØªØ§ÛŒØ¬ Ù…Ù†ÙÛŒ Ù…ÛŒâ€ŒØ±Ø³ÛŒÙ…Ø› Ú†Ù‡ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§ÙÚ©Ø§Ø± Ø¯ÛŒÚ¯Ø±Ø§Ù† Ùˆ Ú†Ù‡ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø®ÙˆØ¯Ù…Ø§Ù†.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±. Ø°Ù‡Ù†â€ŒØ®ÙˆØ§Ù†ÛŒ</h3>
                                    <p>ÙØ±Ø¶ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ù†ÛŒÙ… Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ù…Ø§ Ú†Ù‡ ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.</p>
                                </div>
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û². Ù¾ÛŒØ´â€ŒÚ¯ÙˆÛŒÛŒ</h3>
                                    <p>Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø´ØªÙ† Ø´ÙˆØ§Ù‡Ø¯ Ú©Ø§ÙÛŒ.</p>
                                </div>

                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Ûµ. Ø§Ø³ØªØ¯Ù„Ø§Ù„ Ù‡ÛŒØ¬Ø§Ù†ÛŒ</h3>
                                    <p>Ø³Ø§Ø®ØªÙ† ÛŒÚ© Ø¨Ø§ÙˆØ± ÙÙ‚Ø· Ø¨Ø± Ù¾Ø§ÛŒÙ‡Ù” Ø§Ø­Ø³Ø§Ø³Ø§ØªØŒ Ù†Ù‡ Ø´ÙˆØ§Ù‡Ø¯.</p>
                                </div>

                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Û¶. Ù†Ø§ØªÙˆØ§Ù†ÛŒ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ Ø´ÙˆØ§Ù‡Ø¯ Ù…Ø«Ø¨Øª</h3>
                                    <p>Ø¯Ø§Ø´ØªÙ† ÛŒÚ© ÙÚ©Ø± Ù…Ù†ÙÛŒ Ùˆ Ø±Ø¯ Ú©Ø±Ø¯Ù† Ù‡Ø± Ø¯Ù„ÛŒÙ„ÛŒ Ú©Ù‡ Ø®Ù„Ø§Ù Ø¢Ù† Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
                                </div>
                            </div>
                        </section>

                        <section class="mb-12">
                            <!-- FIX: Changed from ml-3 to mr-3 for RTL -->
                            <h2 class="text-2xl font-bold mb-4 mt-8 flex items-center" style="color: #d7263d;">
                                <span class="text-3xl mr-3">â›°ï¸</span>
                                Ú¯Ø±ÙˆÙ‡ Û³: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ÛŒ (Ø§ØºØ±Ø§Ù‚ Ùˆ Ø¨Ø±Ú†Ø³Ø¨)
                            </h2>
                            <p class="mb-6 text-gray-600">Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ø´Ø§Ù…Ù„ Ø¨Ø²Ø±Ú¯â€ŒÙ†Ù…Ø§ÛŒÛŒ Ø¬Ù†Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†ÙÛŒØŒ ØªØ¹Ù…ÛŒÙ… Ø¯Ø§Ø¯Ù† ÛŒÚ© Ø§ØªÙØ§Ù‚ Ú©ÙˆÚ†Ú© Ø¨Ù‡ Ú©Ù„ Ø²Ù†Ø¯Ú¯ÛŒØŒ ÛŒØ§ Ø²Ø¯Ù† Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒ Ùˆ Ù†Ø§Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡ Ø§Ø³Øª.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û³. ÙØ§Ø¬Ø¹Ù‡â€ŒØ³Ø§Ø²ÛŒ</h3>
                                    <p>Ø¨Ø²Ø±Ú¯â€ŒÙ†Ù…Ø§ÛŒÛŒ Ù…Ù†ÙÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§Ø› Ø§Ø² Ú©Ø§Ù‡ Ú©ÙˆÙ‡ Ø³Ø§Ø®ØªÙ†.</p>
                                </div>
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û´. Ø¨Ø±Ú†Ø³Ø¨â€ŒØ²Ù†ÛŒ</h3>
                                    <p>Ø¯Ø§Ø¯Ù† ÛŒÚ© Ù„ÛŒØ¨Ù„ Ú©Ù„ÛŒ Ø¨Ù‡ Ø®ÙˆØ¯ ÛŒØ§ Ø¯ÛŒÚ¯Ø±Ø§Ù† (Ù…Ø«Ù„Ø§Ù‹: Â«Ù…Ù† Ø¨ÛŒâ€ŒØ¹Ø±Ø¶Ù‡â€ŒØ§Ù…Â»).</p>
                                </div>

                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û·. ØªØ¹Ù…ÛŒÙ… Ø§ÙØ±Ø§Ø·ÛŒ</h3>
                                    <p>ÙˆÙ‚ÙˆØ¹ ÛŒÚ© Ø§ØªÙØ§Ù‚ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ù‡Ù” Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ ØªØ¹Ù…ÛŒÙ… Ø¯Ø§Ø¯Ù† (Ù…Ø«Ù„: Â«Ù…Ù† Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø¯Ø´Ø§Ù†Ø³Ù…Â»).</p>
                                </div>
                            </div>
                        </section>

                        <section class="mb-12">
                            <!-- FIX: Changed from ml-3 to mr-3 for RTL -->
                            <h2 class="text-2xl font-bold mb-4 mt-8 flex items-center" style="color: #d7263d;">
                                <span class="text-3xl mr-3">ğŸ‘¤</span>
                                Ú¯Ø±ÙˆÙ‡ Û´: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª (Ø³Ø±Ø²Ù†Ø´)
                            </h2>
                            <p class="mb-6 text-gray-600">Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ø¨Ù‡ Ù†Ø­ÙˆÙ‡ ØªÙ‚Ø³ÛŒÙ… Ù†Ø§Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ù…Ø±Ø¨ÙˆØ· Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯Ø› ÛŒØ§ Ù‡Ù…Ù‡ ØªÙ‚ØµÛŒØ±Ù‡Ø§ Ø±Ø§ Ø¨Ù‡ Ú¯Ø±Ø¯Ù† Ø®ÙˆØ¯ Ù…ÛŒâ€ŒØ§Ù†Ø¯Ø§Ø²ÛŒÙ… ÛŒØ§ Ù‡Ù…Ù‡ Ø±Ø§ Ù…Ù‚ØµØ± Ù…ÛŒâ€ŒØ¯Ø§Ù†ÛŒÙ….</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Û°. Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ</h3>
                                    <p>ØªÙ‚ØµÛŒØ± Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø±Ø§ Ø¨Ù‡ Ú¯Ø±Ø¯Ù† Ø®ÙˆØ¯ Ø§Ù†Ø¯Ø§Ø®ØªÙ†.</p>
                                </div>
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Û±. Ù…Ù‚ØµØ± Ø¯Ø§Ù†Ø³ØªÙ† Ø¯ÛŒÚ¯Ø±Ø§Ù†</h3>
                                    <p>ØªÙ…Ø§Ù… Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§ Ø±Ø§ ÙÙ‚Ø· Ø¨Ù‡ Ú¯Ø±Ø¯Ù† Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø§Ù†Ø¯Ø§Ø®ØªÙ†.</p>
                                </div>
                            </div>
                        </section>

                        <section class="mb-12">
                            <!-- FIX: Changed from ml-3 to mr-3 for RTL -->
                            <h2 class="text-2xl font-bold mb-4 mt-8 flex items-center" style="color: #d7263d;">
                                <span class="text-3xl mr-3">â³</span>
                                Ú¯Ø±ÙˆÙ‡ Ûµ: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²Ù…Ø§Ù† Ùˆ Ø­Ø³Ø±Øª
                            </h2>
                            <p class="mb-6 text-gray-600">Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø§Ø² Ø®Ø·Ø§Ù‡Ø§ Ø¨Ø± Ù…Ø§Ù†Ø¯Ù† Ø¯Ø± Ú¯Ø°Ø´ØªÙ‡ (Ø­Ø³Ø±Øª Ùˆ Ø§ÛŒ Ú©Ø§Ø´) ÛŒØ§ Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø¢ÛŒÙ†Ø¯Ù‡ (Ù†Ú©Ù†Ø¯Ù‡Ø§ Ùˆ Ø¨Ø§ÛŒØ¯Ù‡Ø§) ØªÙ…Ø±Ú©Ø² Ø¯Ø§Ø±Ù†Ø¯.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û¹. Ø¨Ø§ÛŒØ¯Ù‡Ø§</h3>
                                    <p>Â«Ø¨Ø§ÛŒØ¯Ù‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡Â» Ø§Ø­Ø³Ø§Ø³ Ø­Ø³Ø±Øª Ùˆ Â«Ø¨Ø§ÛŒØ¯Ù‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡Â» Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯.</p>
                                </div>
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Û³. Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø´ÛŒÙ…Ø§Ù† Ø¨ÙˆØ¯Ù†</h3>
                                    <p>ØºØ±Ù‚ Ø´Ø¯Ù† Ø¯Ø± Â«Ú©Ø§Ø´...Â»Ù‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡ Ùˆ Ù‡Ø¯Ø± Ø¯Ø§Ø¯Ù† Ø§Ù†Ø±Ú˜ÛŒ Ùˆ Ø²Ù…Ø§Ù† Ø­Ø§Ù„.</p>
                                </div>

                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Û´. Ù†Ú©Ù†Ù‡â€ŒÙ‡Ø§</h3>
                                    <p>Ø§ÙÚ©Ø§Ø±ÛŒ Ù¾Ø± Ø§Ø² Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø¨ÛŒâ€ŒÙ¾Ø§Ø³Ø®Ø› Ù…Ø«Ù„: Â«Ù†Ú©Ù†Ù‡ Ø­Ø§Ù„Ù… Ø¨Ø¯ Ø¨Ø´Ù‡ØŸÂ»</p>
                                </div>
                            </div>
                        </section>

                        <section class="mb-12">
                            <!-- FIX: Changed from ml-3 to mr-3 for RTL -->
                            <h2 class="text-2xl font-bold mb-4 mt-8 flex items-center" style="color: #d7263d;">
                                <span class="text-3xl mr-3">ğŸ†š</span>
                                Ú¯Ø±ÙˆÙ‡ Û¶: Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡
                            </h2>
                            <p class="mb-6 text-gray-600">Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ Ø§Ø² Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù†Ø§Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡ Ø®ÙˆØ¯ Ø¨Ø§ Ø¯ÛŒÚ¯Ø±Ø§Ù† ÛŒØ§ Ù‚Ø¶Ø§ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ù…ØªØºÛŒØ± Ùˆ Ø³Ù„ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ù†Ø§Ø´ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Û². Ù…Ù‚Ø§ÛŒØ³Ù‡Ù” Ù†Ø§Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡</h3>
                                    <p>Ù…Ù‚Ø§ÛŒØ³Ù‡Ù” Ø®ÙˆØ¯ Ø¨Ø§ Ø§ÙØ±Ø§Ø¯ÛŒ Ú©Ù‡ Ø´Ø±Ø§ÛŒØ· ÛŒØ§ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ù…ØªÙØ§ÙˆØªÛŒ Ø¯Ø§Ø±Ù†Ø¯.</p>
                                </div>
                                
                                <div class="bg-white rounded-lg shadow-md p-6">
                                    <h3 class="font-bold text-lg mb-2" style="color: #f46036;">Û±Û·. Ø¨Ø±Ø®ÙˆØ±Ø¯ Ù‚Ø¶Ø§ÙˆØªÛŒ</h3>
                                    <p>Ù‚Ø¶Ø§ÙˆØª Ø³Ù„ÛŒÙ‚Ù‡â€ŒØ§ÛŒ Ùˆ Ù…ØªØºÛŒØ± Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø´Ø±Ø§ÛŒØ· Ù…Ø´Ø§Ø¨Ù‡.</p>
                                </div>
                            </div>
                        </section>

                        <section class="mb-12">
                            <h2 class="text-3xl font-bold text-center mb-6" style="color: #2e294e;">Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white rounded-lg shadow-md p-6 border-r-4" style="border-color: #1b998b;">
                                    <h3 class="font-bold text-lg mb-2">Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡</h3>
                                    <p class="text-gray-600">ØªÙ†Ù‡Ø§ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø¢Ù† Ù‡Ø³ØªÛŒÙ…ØŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø§Ù…Ø±ÙˆØ² Ø®ÙˆØ¯Ù…Ø§Ù† Ø¨Ø§ Ú¯Ø°Ø´ØªÙ‡ Ø®ÙˆØ¯Ù…Ø§Ù† Ø§Ø³Øª.</p>
                                </div>
                                <div class="bg-white rounded-lg shadow-md p-6 border-r-4" style="border-color: #1b998b;">
                                    <h3 class="font-bold text-lg mb-2">Ø¢Ú¯Ø§Ù‡ÛŒØŒ Ù‚Ø¯Ù… Ø§ÙˆÙ„</h3>
                                    <p class="text-gray-600">Ø´Ù†Ø§Ø®Øª Ùˆ Ø¢Ú¯Ø§Ù‡ÛŒ Ø§Ø² Ø§ÛŒÙ† Ø®Ø·Ø§Ù‡Ø§ØŒ Ø§ÙˆÙ„ÛŒÙ† Ùˆ Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ù‚Ø¯Ù… Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ Ú†Ø§Ù„Ø´ Ú©Ø´ÛŒØ¯Ù† Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ù†â€ŒÙ‡Ø§Ø³Øª.</p>
                                </div>
                            </div>
                        </section>
                         












                        <div class="flex items-center justify-center gap-x-4 pt-8 border-t mt-12">
                            <button id="back-to-log-btn" class="px-8 py-3 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 transition-all w-full md:w-auto">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú¯Ø§Ù… Û³</button>
                            <button id="go-to-challenge-btn" class="px-8 py-3 rounded-lg font-semibold bg-green-600 text-white shadow-md hover:bg-green-700 transition-all w-full md:w-auto">
                                Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ù‡ Ú¯Ø§Ù… Ûµ: Ú†Ø§Ù„Ø´ Ø§ÙÚ©Ø§Ø±
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const renderIdentifyThoughtsPage = () => {
                const pageContainer = document.getElementById('page-content-container');
                if (!pageContainer) return;
                
                pageContainer.innerHTML = htmlTemplates_IdentifyThoughts;
                
                document.getElementById('go-to-challenge-btn').addEventListener('click', () => {
                    // NEW: Unlock and navigate
                    unlockStep('thoughtChallenge');
                    currentStepId = 'thoughtChallenge';
                    mainRouter();
                });
                
                document.getElementById('back-to-log-btn').addEventListener('click', () => {
                    currentStepId = 'thoughtLog';
                    mainRouter();
                });
            };
            

            // --- SECTION 8: MODULE: THOUGHT CHALLENGE (Step 5) ---
            
            // NEW: This page is now dynamic. It finds the entry to challenge.
            const renderThoughtChallengePage = () => {
                const pageContainer = document.getElementById('page-content-container');
                if (!pageContainer) return;

                // NEW: Find the first incomplete entry
                const entryToChallenge = thoughtLog.find(e => !e.negativeThoughts.every(t => t.alternativeThought && t.conclusion));
                currentEntryId = entryToChallenge ? entryToChallenge.id : null; // Set for save function

                let pageHtml;

                if (!entryToChallenge) {
                    // All entries are complete!
                    pageHtml = `
                    <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
                        <h1 class="text-3xl font-extrabold text-green-600 mb-6">ØªØ¨Ø±ÛŒÚ©!</h1>
                        <p class="text-lg text-gray-700 mb-8">
                            Ø´Ù…Ø§ ØªÙ…Ø§Ù… ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ú†Ø§Ù„Ø´ Ú©Ø´ÛŒØ¯Ù‡â€ŒØ§ÛŒØ¯.
                        </p>
                        <p class="text-gray-600">
                            Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ Ú¯Ø§Ù… Û³ Ø¨Ø±Ú¯Ø±Ø¯ÛŒØ¯ Ùˆ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯ÛŒ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.
                        </p>
                        <div class="mt-8 pt-6 border-t">
                             <button id="back-to-log-button" class="px-8 py-3 rounded-lg font-semibold bg-blue-600 text-white shadow-md hover:bg-blue-700 transition-all w-full md:w-auto">
                                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú¯Ø§Ù… Û³: Ø«Ø¨Øª Ø§ÙÚ©Ø§Ø±
                             </button>
                        </div>
                    </div>
                    `;
                } else {
                    // Found an entry to challenge
                    const challengeHtml = entryToChallenge.negativeThoughts
                        .filter(thought => !thought.alternativeThought || !thought.conclusion) // Only show incomplete thoughts
                        .map((thought, index) => `
                        <div class="bg-white p-6 rounded-xl shadow-md border space-y-6">
                            <div>
                                <p class="text-sm font-semibold text-gray-500">Û³. ÙÚ©Ø± Ù…Ù†ÙÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± (Ø§Ù…ØªÛŒØ§Ø²: ${thought.score}/10)</p>
                                <p class="p-3 bg-red-50 border-r-4 border-red-400 rounded-md mt-1 text-gray-800 break-words">${thought.description}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 class="font-bold text-lg text-gray-700 mb-4">Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ§Ù‡Ø¯ (Ú©Ù…Ú© Ø¨Ù‡ ÛŒØ§ÙØªÙ† ÙÚ©Ø± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†)</h3>
                                <div class="space-y-4 text-sm">
                                    <div class="space-y-1">
                                        <label for="challenge-distortion-${index}" class="font-semibold text-gray-600">Ø¢ÛŒØ§ Ø§ÛŒÙ† ÙÚ©Ø± ÛŒÚ© Ø®Ø·Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÛŒ Ø§Ø³Øª ÛŒØ§ ÛŒÚ© ÙˆØ§Ù‚Ø¹ÛŒØªØŸ</label>
                                        <textarea id="challenge-distortion-${index}" data-thought-id="${thought.id}" rows="2" class="challenge-input w-full p-2 border rounded-lg mt-1">${thought.challenge_distortion || ''}</textarea>
                                    </div>
                                    <div class="space-y-1">
                                        <label for="challenge-experience-${index}" class="font-semibold text-gray-600">Ø¢ÛŒØ§ Ù‚Ø¨Ù„Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¨ÙˆØ¯Ù‡â€ŒØ§Ù…ØŸ Ú†Ú¯ÙˆÙ†Ù‡ Ø¢Ù† Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø±Ø¯Ù…ØŸ</label>
                                        <textarea id="challenge-experience-${index}" data-thought-id="${thought.id}" rows="2" class="challenge-input w-full p-2 border rounded-lg mt-1">${thought.challenge_experience || ''}</textarea>
                                    </div>
                                    <div class="space-y-1">
                                        <label for="challenge-others-${index}" class="font-semibold text-gray-600">Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¯Ø± Ø§ÛŒÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª Ú†Ù‡ Ú©Ø§Ø± Ø®ÙˆØ§Ù‡Ù†Ø¯ Ú©Ø±Ø¯ØŸ</label>
                                        <textarea id="challenge-others-${index}" data-thought-id="${thought.id}" rows="2" class="challenge-input w-full p-2 border rounded-lg mt-1">${thought.challenge_others || ''}</textarea>
                                    </div>
                                     <div class="space-y-1">
                                        <label for="challenge-another-way-${index}" class="font-semibold text-gray-600">Ú†Ù‡ Ø´Ú©Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø¨Ù‡ Ø§ÛŒÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª ÙÚ©Ø± Ú©Ø±Ø¯ØŸ</label>
                                        <textarea id="challenge-another-way-${index}" data-thought-id="${thought.id}" rows="2" class="challenge-input w-full p-2 border rounded-lg mt-1">${thought.challenge_anotherWay || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4 space-y-2">
                                 <label for="alternative-thought-${index}" class="block font-bold text-lg text-gray-700">Û´. Ø§ÙÚ©Ø§Ø± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†</label>
                                 <textarea id="alternative-thought-${index}" data-thought-id="${thought.id}" rows="3" class="challenge-input w-full p-2 border-2 border-green-200 rounded-lg focus:ring-green-500 focus:border-green-500">${thought.alternativeThought || ''}</textarea>
                            </div>
                            <div class="space-y-2">
                                <label for="conclusion-${index}" class="block font-bold text-lg text-gray-700">Ûµ. Ù†ØªÛŒØ¬Ù‡ Ú¯ÛŒØ±ÛŒ</label>
                                 <textarea id="conclusion-${index}" data-thought-id="${thought.id}" rows="3" class="challenge-input w-full p-2 border-2 border-blue-200 rounded-lg focus:ring-blue-500 focus:border-blue-500">${thought.conclusion || ''}</textarea>
                            </div>
                        </div>
                    `).join('');

                    pageHtml = `
                    <div class="space-y-6">
                        <h1 class="text-3xl font-extrabold text-blue-800 mb-2">Ú¯Ø§Ù… Ûµ: Ú†Ø§Ù„Ø´ Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø§ÙÚ©Ø§Ø±</h1>
                        <p class="text-lg text-gray-600 mb-6">Ø¯Ø± Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø§ÙˆÙ„ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ØªÚ©Ù…ÛŒÙ„â€ŒÙ†Ø´Ø¯Ù‡â€ŒÛŒ Ø´Ù…Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§ÙÚ©Ø§Ø± Ù…Ù†ÙÛŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ Ú†Ø§Ù„Ø´ Ø¨Ú©Ø´ÛŒØ¯.</p>
                        
                        <div class="bg-white p-6 rounded-xl shadow-md border">
                            <p class="text-sm font-semibold text-gray-500">Û±. Ù…ÙˆÙ‚Ø¹ÛŒØª</p>
                            <p class="mt-1 text-gray-800 break-words">${entryToChallenge.situation}</p> 
                            <hr class="my-4">
                            <p class="text-sm font-semibold text-gray-500">Û². Ø§Ø­Ø³Ø§Ø³Ø§Øª</p>
                            <p class="mt-1 text-gray-800">${entryToChallenge.feelings.map(f => `${f.name}: ${f.score}/10`).join(' - ')}</p>
                        </div>
                        
                        <div id="challenge-items-container" class="space-y-6">${challengeHtml}</div>
                        
                        <div class="flex items-center justify-center gap-x-4 pt-8 border-t mt-8">
                            <button id="back-to-log-button" class="px-8 py-3 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 transition-all w-full md:w-auto">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú¯Ø§Ù… Û³</button>
                            <button id="save-challenge-button" class="px-8 py-3 rounded-lg font-semibold bg-green-500 text-white shadow-md hover:bg-green-600 transition-all w-full md:w-auto">Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø§Ø¯Ø§Ù…Ù‡</button>
                       </div>
                    </div>
                    `;
                }

                pageContainer.innerHTML = pageHtml;
                attachThoughtChallengeListeners();
            };
            
            const handleUpdateChallenge = () => {
                if (currentEntryId === null) return; // No entry to save

                const entryIndex = thoughtLog.findIndex(e => e.id === currentEntryId);
                if (entryIndex === -1) return;

                // Find all inputs and textareas related to the challenge
                document.querySelectorAll('.challenge-input').forEach(input => {
                    const thoughtId = parseFloat(input.dataset.thoughtId);
                    const thoughtIndex = thoughtLog[entryIndex].negativeThoughts.findIndex(t => t.id === thoughtId);
                    if (thoughtIndex === -1) return;
                    
                    // Determine which field to save to
                    if (input.id.startsWith('challenge-distortion-')) thoughtLog[entryIndex].negativeThoughts[thoughtIndex].challenge_distortion = input.value;
                    else if (input.id.startsWith('challenge-experience-')) thoughtLog[entryIndex].negativeThoughts[thoughtIndex].challenge_experience = input.value;
                    else if (input.id.startsWith('challenge-others-')) thoughtLog[entryIndex].negativeThoughts[thoughtIndex].challenge_others = input.value;
                    else if (input.id.startsWith('challenge-another-way-')) thoughtLog[entryIndex].negativeThoughts[thoughtIndex].challenge_anotherWay = input.value;
                    else if (input.id.startsWith('alternative-thought-')) thoughtLog[entryIndex].negativeThoughts[thoughtIndex].alternativeThought = input.value;
                    else if (input.id.startsWith('conclusion-')) thoughtLog[entryIndex].negativeThoughts[thoughtIndex].conclusion = input.value;
                });

                saveUserData();
                showMessage("Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
                
                // NEW: Re-render the same page. It will automatically find the *next* incomplete entry or show "Congrats".
                renderThoughtChallengePage();
            };
            
            const attachThoughtChallengeListeners = () => {
                const backBtn = document.getElementById('back-to-log-button');
                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        currentStepId = 'thoughtLog';
                        mainRouter();
                    });
                }
                
                const saveBtn = document.getElementById('save-challenge-button');
                if (saveBtn) {
                    saveBtn.addEventListener('click', handleUpdateChallenge);
                }
            };

            // --- SECTION 9: MODULE: EDIT MODAL (Shared) ---
            
            const htmlTemplates_EditModal = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
                    <div class="modal-container bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 transform scale-95 transition-all duration-300">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="font-semibold" for="edit-situation">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
                                <textarea id="edit-situation" rows="3" class="w-full p-2 border rounded-lg mt-1"></textarea>
                            </div>
                            <div>
                                <label class="font-semibold">Ø§Ø­Ø³Ø§Ø³Ø§Øª</label>
                                <div class="grid grid-cols-3 gap-4 mt-1">
                                    <div class="text-center"><label for="edit-feeling-sad">ØºÙ…</label><input type="number" id="edit-feeling-sad" min="0" max="10" class="w-full p-2 border text-center rounded-lg number-input"></div>
                                    <div class="text-center"><label for="edit-feeling-happy">Ø®Ø´Ù…</label><input type="number" id="edit-feeling-happy" min="0" max="10" class="w-full p-2 border text-center rounded-lg number-input"></div>
                                    <div class="text-center"><label for="edit-feeling-anxious">Ø§Ø¶Ø·Ø±Ø§Ø¨</label><input type="number" id="edit-feeling-anxious" min="0" max="10" class="w-full p-2 border text-center rounded-lg number-input"></div>
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold">Ø§ÙÚ©Ø§Ø± Ù…Ù†ÙÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</label>
                                <div id="edit-thoughts-container"></div>
                                <button id="add-edit-thought-button" class="mt-4 text-sm text-blue-600 font-semibold hover:text-blue-800">+ Ø§ÙØ²ÙˆØ¯Ù† ÙÚ©Ø± Ø¯ÛŒÚ¯Ø±</button>
                            </div>
                        </div>
                        <div class="flex justify-end gap-4 border-t pt-6 mt-6">
                            <button id="cancel-edit" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                            <button id="save-update" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                        </div>
                    </div>
                </div>
            `;

            const openEditModal = (id) => {
                 const entry = thoughtLog.find(e => e.id === id);
                if (!entry) return;
                
                const thoughtsHtml = entry.negativeThoughts.map(thought => `
                    <div class="edit-thought-group border-t pt-4 mt-4 space-y-2 relative" data-thought-id="${thought.id}">
                        <textarea class="w-full p-2 border rounded-lg">${thought.description}</textarea>
                        <input type="number" min="0" max="10" value="${thought.score}" class="w-full p-2 border text-center rounded-lg number-input">
                        <button class="remove-thought-btn absolute -top-2 right-0 text-red-500 hover:text-red-700 w-8 h-8 flex items-center justify-center text-2xl font-bold">&times;</button>
                    </div>`).join('');
                
                editModalContainer.innerHTML = htmlTemplates_EditModal;
                
                document.getElementById('edit-situation').value = entry.situation;
                document.getElementById('edit-feeling-sad').value = entry.feelings.find(f=>f.name==='ØºÙ…')?.score || 0;
                document.getElementById('edit-feeling-happy').value = entry.feelings.find(f=>f.name==='Ø®Ø´Ù…')?.score || 0;
                document.getElementById('edit-feeling-anxious').value = entry.feelings.find(f=>f.name==='Ø§Ø¶Ø·Ø±Ø§Ø¨')?.score || 0;
                document.getElementById('edit-thoughts-container').innerHTML = thoughtsHtml;

                editModalContainer.classList.remove('hidden');
                setTimeout(() => { 
                    editModalContainer.querySelector('.modal-overlay').classList.add('opacity-100');
                    editModalContainer.querySelector('.modal-container').classList.add('scale-100');
                }, 10);
                
                document.getElementById('save-update').addEventListener('click', () => handleUpdateThought(id));
                document.getElementById('cancel-edit').addEventListener('click', closeEditModal);
                editModalContainer.querySelector('.modal-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeEditModal() });
                
                document.getElementById('add-edit-thought-button').addEventListener('click', () => {
                    const container = document.getElementById('edit-thoughts-container');
                    const newThoughtGroup = document.createElement('div');
                    newThoughtGroup.className = 'edit-thought-group border-t pt-4 mt-4 space-y-2 relative';
                    newThoughtGroup.innerHTML = `
                        <textarea class="w-full p-2 border rounded-lg" placeholder="ÙÚ©Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                        <input type="number" min="0" max="10" class="w-full p-2 border text-center rounded-lg number-input" placeholder="Ø´Ø¯Øª ÙÚ©Ø± (Û°-Û±Û°)">
                        <button class="remove-thought-btn absolute -top-2 right-0 text-red-500 hover:text-red-700 w-8 h-8 flex items-center justify-center text-2xl font-bold">&times;</button>
                    `;
                    container.appendChild(newThoughtGroup);
                    newThoughtGroup.querySelector('.remove-thought-btn').addEventListener('click', () => newThoughtGroup.remove());
                });
                
                editModalContainer.querySelectorAll('.remove-thought-btn').forEach(btn => btn.addEventListener('click', (e) => e.currentTarget.parentElement.remove()));
            };

            const closeEditModal = () => {
                const overlay = editModalContainer.querySelector('.modal-overlay');
                if (overlay) {
                    overlay.classList.remove('opacity-100');
                    overlay.querySelector('.modal-container').classList.remove('scale-100');
                    setTimeout(() => { 
                        editModalContainer.classList.add('hidden');
                        editModalContainer.innerHTML = '';
                    }, 300);
                }
            };
            
            const handleUpdateThought = (id) => {
                const situation = document.getElementById('edit-situation').value;
                const thoughtNodes = document.querySelectorAll('.edit-thought-group');
                const newNegativeThoughts = [];

                const entryIndex = thoughtLog.findIndex(e => e.id === id);
                if (entryIndex === -1) return; 
                const originalThoughts = thoughtLog[entryIndex].negativeThoughts;

                thoughtNodes.forEach(node => {
                    const description = node.querySelector('textarea').value;
                    const score = node.querySelector('input[type="number"]').value;
                    const thoughtId = node.dataset.thoughtId; 
                    
                    if (!description || !score) return; 
                    
                    if (thoughtId && thoughtId !== "undefined") {
                        const originalThought = originalThoughts.find(t => t.id == thoughtId);
                        if (originalThought) {
                            newNegativeThoughts.push({
                                ...originalThought,
                                description: description,
                                score: parseInt(score)
                            });
                        }
                    } else {
                        newNegativeThoughts.push({
                            id: Date.now() + Math.random(),
                            description,
                            score: parseInt(score),
                            challenge_distortion: '', challenge_experience: '', challenge_others: '', challenge_anotherWay: '',
                            alternativeThought: '', conclusion: ''
                        });
                    }
                });

                if (!situation || newNegativeThoughts.length === 0) {
                    showMessage("Ù…ÙˆÙ‚Ø¹ÛŒØª Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙÚ©Ø± Ù…Ù†ÙÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ù†Ø¯.", true);
                    return;
                }

                thoughtLog[entryIndex].situation = situation;
                thoughtLog[entryIndex].negativeThoughts = newNegativeThoughts; 
                thoughtLog[entryIndex].feelings = [
                    { name: 'ØºÙ…', score: parseInt(document.getElementById('edit-feeling-sad').value) || 0 },
                    { name: 'Ø®Ø´Ù…', score: parseInt(document.getElementById('edit-feeling-happy').value) || 0 },
                    { name: 'Ø§Ø¶Ø·Ø±Ø§Ø¨', score: parseInt(document.getElementById('edit-feeling-anxious').value) || 0 }
                ];
                
                saveUserData();
                closeEditModal();
                renderThoughtLogPage();
                showMessage("ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.");
            };
            

            // --- SECTION 10: APP DEFINITION & ROUTER ---
            
            // NEW: This is now the single source of truth for the user journey
            const journeySteps = [
                {
                    id: 'screening',
                    title: 'Ú¯Ø§Ù… Û±: ØªØ³Øª ØºØ±Ø¨Ø§Ù„Ú¯Ø±ÛŒ',
                    icon: icons.screening,
                    renderFunction: renderScreeningPage,
                },
                {
                    id: 'pathIntro',
                    title: 'Ú¯Ø§Ù… Û²: Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø·Ø§Ù„Ø¹Ù‡',
                    icon: icons.intro,
                    renderFunction: renderPathIntroPage,
                },
                {
                    id: 'thoughtLog',
                    title: 'Ú¯Ø§Ù… Û³: Ø«Ø¨Øª Ø§ÙÚ©Ø§Ø±',
                    icon: icons.log,
                    renderFunction: renderThoughtLogPage,
                },
                {
                    id: 'identifyThoughts',
                    title: 'Ú¯Ø§Ù… Û´: Ø´Ù†Ø§Ø®Øª Ø®Ø·Ø§Ù‡Ø§',
                    icon: icons.identify,
                    renderFunction: renderIdentifyThoughtsPage,
                },
                {
                    id: 'thoughtChallenge',
                    title: 'Ú¯Ø§Ù… Ûµ: Ú†Ø§Ù„Ø´ Ø§ÙÚ©Ø§Ø±',
                    icon: icons.challenge,
                    renderFunction: renderThoughtChallengePage,
                }
            ];
            
            const mainRouter = () => {
                // 1. Load/Refresh State for globals: currentUser, unlockedSteps, etc.
                loadUserData(); 

                if (!currentUser) {
                    // 2. Not logged in: Render Auth Form directly into appContainer
                    appContainer.innerHTML = htmlTemplates_Auth;
                    renderAuthForm(); 
                    return;
                }
                
                // 3. Logged in: Render main application shell
                // Ensure layout is rendered
                if (!document.getElementById('sidebar')) {
                    renderAppLayout();
                }

                // 4. Render the sidebar navigation
                renderSidebarNav(); 

                // 5. Find and render the current page
                const step = journeySteps.find(s => s.id === currentStepId);
                
                if (step && unlockedSteps.includes(step.id)) {
                    step.renderFunction(); 
                } else {
                    // Fallback: Go to first unlocked step
                    currentStepId = unlockedSteps[0] || 'screening';
                    journeySteps.find(s => s.id === currentStepId).renderFunction(); 
                }
                
                saveUserData();
            };
            
            // --- Initial Load ---
            mainRouter();
        });
    </script>

    <!-- 4. FOOTER -->
    <footer class="w-full bg-white text-gray-500 text-center py-3 border-t border-gray-200 text-xs flex-shrink-0">
        <p>Adel Marzban = code engineering | Hamid Shamseh = psychological methods</p>
        <p class="mt-1">adelmarzban.github.io | powered with google gemini</p>
    </footer>

</body>
</html>
